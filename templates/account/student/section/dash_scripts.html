{% load static %}

<!-- ── Vendor libraries ───────────────────────────────────────────── -->
<script src="{% static 'js/chart.umd.min.js' %}"></script>
<script src="{% static 'js/flatpickr.min.js' %}"></script>

{{ grade_labels|json_script:"grade-labels" }}
{{ grade_values|json_script:"grade-values" }}
{{ attendance_data|json_script:"attendance-json" }}
{{ starplot_detail_json|json_script:"starplot_detail_json" }}

<script>
/* ═════════════════ 1. Small Radar Chart (Latest Quarter) ══════════ */
(() => {
    const labels = JSON.parse(document.getElementById("grade-labels").textContent || "[]");
    const values = JSON.parse(document.getElementById("grade-values").textContent || "[]");
    if (!labels.length || !values.length) return;

    const ctx = document.getElementById("gradeRadarChart").getContext("2d");

    window.gradeChart = new Chart(ctx, {
        type: "radar",
        data: {
            labels,
            datasets: [{
                data: values,
                label: "Final Grade",
                backgroundColor: "rgba(54,162,235,0.2)",
                borderColor: "rgba(54,162,235,1)",
                borderWidth: 2,
                pointRadius: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                r: {
                    min: 70,
                    max: 100,
                    ticks: { stepSize: 5 }
                }
            },
            plugins: { legend: { display: false } }
        }
    });
})();
</script>

<script>
/* ═════════════════ 2. Attendance Calendar (Flatpickr) ═════════════ */
(() => {
    const records = JSON.parse(document.getElementById("attendance-json").textContent || "[]");

    flatpickr("#calendar", {
        inline: true,
        disableMobile: true,
        onDayCreate(_,__,___,day) {
            const date = day.dateObj.toISOString().split("T")[0];
            const rec = records.find(r => r.date === date);
            if (rec) {
                day.classList.add("attendance-" + rec.status);
                day.title = rec.status[0].toUpperCase() + rec.status.slice(1);
            }
        }
    });

    flatpickr("#calendar-modal-input", {
        inline: true,
        disableMobile: true,
        onDayCreate(_,__,___,day) {
            const date = day.dateObj.toISOString().split("T")[0];
            const rec = records.find(r => r.date === date);
            if (rec) {
                day.classList.add("attendance-" + rec.status);
                day.title = rec.status[0].toUpperCase() + rec.status.slice(1);
            }
        }
    });
})();
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("starplot-modal");
    const closeBtn = document.getElementById("sp-close");
    const prevBtn = document.getElementById("sp-prev");
    const nextBtn = document.getElementById("sp-next");
    const quarterLabel = document.getElementById("sp-quarter-label");
    const chartContainer = document.getElementById("sp-chart-container");
    const unavailableMsg = document.getElementById("sp-unavailable");
    const ctx = document.getElementById("sp-quarter-chart").getContext("2d");

    const starplotData = JSON.parse('{{ all_quarters_starplot_json|escapejs }}');
    let currentQuarter = 1;
    let chartInstance = null;

    function renderQuarter(quarter) {
    const data = starplotData[quarter];

    if (!data || data.values.length === 0) {
        chartContainer.style.display = "none";
        unavailableMsg.style.display = "block";

        const missingList = document.getElementById("sp-missing-list");
        missingList.innerHTML = ""; // Clear old list
        if (data && data.missing_subjects.length > 0) {
            data.missing_subjects.forEach(subj => {
                const li = document.createElement("li");
                li.textContent = subj;
                missingList.appendChild(li);
            });
        }
        return;
    }

    chartContainer.style.display = "block";
    unavailableMsg.style.display = "none";

    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
        type: "radar",
        data: {
            labels: data.labels,
            datasets: [{
                label: `Quarter ${quarter}`,
                data: data.values,
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                borderColor: "rgba(54, 162, 235, 1)",
                pointBackgroundColor: "rgba(54, 162, 235, 1)"
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    suggestedMin: 0,
                    suggestedMax: 100
                }
            }
        }
    });
}


    function updateQuarter(delta) {
        currentQuarter = ((currentQuarter - 1 + delta + 4) % 4) + 1;
        quarterLabel.textContent = `Quarter ${currentQuarter}`;
        renderQuarter(currentQuarter);
    }

    // Event Listeners
    prevBtn.addEventListener("click", () => updateQuarter(-1));
    nextBtn.addEventListener("click", () => updateQuarter(1));
    closeBtn.addEventListener("click", () => modal.classList.remove("show"));

    // Trigger opening modal from container click
    document.querySelector(".star-plot").addEventListener("click", () => {
        modal.classList.add("show");
        currentQuarter = 1;
        quarterLabel.textContent = "Quarter 1";
        renderQuarter(1);
    });
});
</script>





<script>
  // Calendar Modal
document.addEventListener("DOMContentLoaded", () => {
  const calendarTrigger = document.getElementById("calendarModalTrigger");
  const calendarModal = document.getElementById("calendar-modal");
  const calendarClose = document.querySelector(".calendar-close");

  if (!calendarTrigger || !calendarModal || !calendarClose) {
    console.warn("Calendar modal elements not found.");
    return;
  }

  calendarTrigger.addEventListener("click", () => {
    calendarModal.classList.remove("hidden");
    calendarModal.classList.add("flex");
  });

  calendarClose.addEventListener("click", () => {
    calendarModal.classList.remove("flex");
    calendarModal.classList.add("hidden");
  });

  window.addEventListener("click", (e) => {
    if (e.target === calendarModal) {
      calendarModal.classList.remove("flex");
      calendarModal.classList.add("hidden");
    }
  });
});
</script>



<script>
document.addEventListener("DOMContentLoaded", () => {
  const annItems = document.querySelectorAll(".announcement-item");
  const modal    = document.getElementById("announcement-modal");
  const closeBtn = document.getElementById("announcement-close");
  const title    = document.getElementById("ann-modal-title");
  const meta     = document.getElementById("ann-modal-meta");
  const body     = document.getElementById("ann-modal-body");

  annItems.forEach(item => {
  item.addEventListener("click", () => {
    title.textContent = item.dataset.annTitle;
    meta.textContent = item.dataset.annMeta;

    // Decode escaped JS string (e.g., \u000A → newline)
    const content = JSON.parse(`"${item.dataset.annContent}"`);
    body.innerHTML = content.replace(/\n/g, "<br>");

    modal.classList.remove("hidden");
    modal.classList.add("flex");
  });
});

  closeBtn.addEventListener("click", () => {
    modal.classList.remove("flex");
    modal.classList.add("hidden");
  });

  window.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.classList.remove("flex");
      modal.classList.add("hidden");
    }
  });
});
</script>



<script>
document.addEventListener("DOMContentLoaded", () => {
  const badgeTrigger = document.getElementById("badgeModalTrigger");
  const badgeModal   = document.getElementById("badge-modal");
  const badgeClose   = document.getElementById("badge-close");

  if (!badgeTrigger || !badgeModal || !badgeClose) {
    console.warn("Badge modal elements not found.");
    return;
  }

  badgeTrigger.addEventListener("click", () => {
    badgeModal.classList.remove("hidden");
    badgeModal.classList.add("flex");
  });

  badgeClose.addEventListener("click", () => {
    badgeModal.classList.remove("flex");
    badgeModal.classList.add("hidden");
  });

  window.addEventListener("click", (e) => {
    if (e.target === badgeModal) {
      badgeModal.classList.remove("flex");
      badgeModal.classList.add("hidden");
    }
  });
});
</script>





<script>
document.addEventListener("DOMContentLoaded", () => {
  const nameTrigger = document.getElementById("nameModalTrigger");
  const nameModal   = document.getElementById("name-modal");
  const nameClose   = document.getElementById("name-close");

  if (!nameTrigger || !nameModal || !nameClose) {
    console.warn("Name modal elements not found.");
    return;
  }

  nameTrigger.addEventListener("click", () => {
    nameModal.classList.remove("hidden");
    nameModal.classList.add("flex");
  });

  nameClose.addEventListener("click", () => {
    nameModal.classList.remove("flex");
    nameModal.classList.add("hidden");
  });

  window.addEventListener("click", (e) => {
    if (e.target === nameModal) {
      nameModal.classList.remove("flex");
      nameModal.classList.add("hidden");
    }
  });
});
</script>





